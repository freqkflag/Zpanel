version: '3.8'

services:
  zpanel:
    image: ghcr.io/freqkflag/zpanel:latest
    container_name: zpanel-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:8080"
    environment:
      APP_NAME: "${APP_NAME:-Zpanel}"
      APP_ENV: production
      APP_KEY: "${APP_KEY}"
      APP_DEBUG: "false"
      APP_URL: "${APP_URL:-http://localhost}"
      
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: "${DB_DATABASE:-zpanel}"
      DB_USERNAME: "${DB_USERNAME:-zpanel}"
      DB_PASSWORD: "${DB_PASSWORD}"
      
      REDIS_HOST: redis
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
      REDIS_PORT: 6379
      
      PUSHER_HOST: soketi
      PUSHER_PORT: 6001
      PUSHER_SCHEME: http
      PUSHER_APP_ID: "${PUSHER_APP_ID:-zpanel}"
      PUSHER_APP_KEY: "${PUSHER_APP_KEY:-zpanel}"
      PUSHER_APP_SECRET: "${PUSHER_APP_SECRET:-zpanel}"
      
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: redis
      CACHE_DRIVER: redis
      
      # Code Server
      CODE_SERVER_URL: "http://code-server:8080"
      CODE_SERVER_PASSWORD: "${CODE_SERVER_PASSWORD}"
      
      # Kong API Gateway
      KONG_ADMIN_URL: "http://kong:8001"
      KONG_PROXY_URL: "http://kong:8000"
      
      # Cloudflare (Optional)
      CLOUDFLARE_API_TOKEN: "${CLOUDFLARE_API_TOKEN:-}"
      CLOUDFLARE_ACCOUNT_ID: "${CLOUDFLARE_ACCOUNT_ID:-}"
      
    volumes:
      - zpanel_storage:/var/www/html/storage
      - zpanel_backups:/var/www/html/storage/app/backups
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - zpanel
    depends_on:
      - postgres
      - redis
      - soketi
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15-alpine
    container_name: zpanel-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: "${DB_DATABASE:-zpanel}"
      POSTGRES_USER: "${DB_USERNAME:-zpanel}"
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - zpanel_postgres_data:/var/lib/postgresql/data
    networks:
      - zpanel
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-zpanel}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: zpanel-redis
    restart: unless-stopped
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - zpanel_redis_data:/data
    networks:
      - zpanel
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  soketi:
    image: quay.io/soketi/soketi:1.6-16-alpine
    container_name: zpanel-soketi
    restart: unless-stopped
    ports:
      - "${SOKETI_PORT:-6001}:6001"
    environment:
      SOKETI_DEBUG: "false"
      SOKETI_DEFAULT_APP_ID: "${PUSHER_APP_ID:-zpanel}"
      SOKETI_DEFAULT_APP_KEY: "${PUSHER_APP_KEY:-zpanel}"
      SOKETI_DEFAULT_APP_SECRET: "${PUSHER_APP_SECRET:-zpanel}"
    networks:
      - zpanel
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:6001/ready"]
      interval: 10s
      timeout: 5s
      retries: 3

  code-server:
    image: codercom/code-server:latest
    container_name: zpanel-code-server
    restart: unless-stopped
    environment:
      PASSWORD: "${CODE_SERVER_PASSWORD}"
    volumes:
      - zpanel_ide_workspaces:/home/coder/project
      - zpanel_ide_config:/home/coder/.local
    networks:
      - zpanel
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3

  kong-database:
    image: postgres:15-alpine
    container_name: zpanel-kong-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: "${KONG_DB_PASSWORD:-kong}"
      POSTGRES_DB: kong
    volumes:
      - zpanel_kong_postgres:/var/lib/postgresql/data
    networks:
      - zpanel
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5

  kong-migrations:
    image: kong:latest
    container_name: zpanel-kong-migrations
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: "${KONG_DB_PASSWORD:-kong}"
      KONG_PG_DATABASE: kong
    networks:
      - zpanel
    depends_on:
      - kong-database
    restart: on-failure

  kong:
    image: kong:latest
    container_name: zpanel-kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: "${KONG_DB_PASSWORD:-kong}"
      KONG_PG_DATABASE: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
    networks:
      - zpanel
    depends_on:
      - kong-database
      - kong-migrations
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  zpanel_storage:
    driver: local
  zpanel_backups:
    driver: local
  zpanel_postgres_data:
    driver: local
  zpanel_redis_data:
    driver: local
  zpanel_ide_workspaces:
    driver: local
  zpanel_ide_config:
    driver: local
  zpanel_kong_postgres:
    driver: local

networks:
  zpanel:
    name: zpanel-network
    driver: bridge
